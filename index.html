<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal Matrix Client</title>
    <script src="https://unpkg.com/matrix-js-sdk@latest/dist/browser-matrix.min.js"></script>
    <style>
        #log { font-family: monospace; background: #eee; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h2>Matrix Web Client</h2>
    <div id="login-form">
        <input type="text" id="hs-url" value="https://matrix.org">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <div id="client-area" style="display:none;">
        <h3>Welcome, <span id="user-display"></span></h3>
        <div id="log"></div>
    </div>

    <script>
        let matrixClient;

// Automatically try to resume session on page load
window.onload = async () => {
    const savedAddress = localStorage.getItem("mx_hs_url");
    const savedToken = localStorage.getItem("mx_access_token");
    const savedUserId = localStorage.getItem("mx_user_id");

    if (savedToken && savedUserId && savedAddress) {
        showClientArea(savedUserId);
        
        // Initialize client with existing token
        matrixClient = matrixcs.createClient({
            baseUrl: savedAddress,
            accessToken: savedToken,
            userId: savedUserId
        });

        await startSync();
    }
};

async function login() {
    const baseUrl = document.getElementById('hs-url').value;
    const user = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    matrixClient = matrixcs.createClient(baseUrl);

    try {
        const result = await matrixClient.login("m.login.password", { user, password });
        
        // Save credentials to LocalStorage
        localStorage.setItem("mx_hs_url", baseUrl);
        localStorage.setItem("mx_access_token", result.access_token);
        localStorage.setItem("mx_user_id", result.user_id);

        showClientArea(result.user_id);
        await startSync();
    } catch (err) {
        alert("Login failed: " + err.message);
    }
}

function showClientArea(userId) {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('client-area').style.display = 'block';
    document.getElementById('user-display').innerText = userId;
}

async function startSync() {
    // initialSyncLimit: 10 (rounded as requested)
    await matrixClient.startClient({ initialSyncLimit: 10 });

    matrixClient.once('sync', (state) => {
        if (state === "PREPARED") {
            appendLog("Session Resumed & Synced!");
            listenForMessages();
        }
    });
}

function logout() {
    localStorage.clear();
    location.reload();
}
    </script>
</body>
</html>


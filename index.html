<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal Matrix Client</title>
    <script src="https://unpkg.com/matrix-js-sdk@latest/dist/browser-matrix.min.js"></script>
    <style>
        #log { font-family: monospace; background: #eee; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h2>Matrix Web Client</h2>
    <div id="login-form">
        <input type="text" id="hs-url" value="https://matrix.org">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <div id="client-area" style="display:none;">
        <h3>Welcome, <span id="user-display"></span></h3>
        <div id="log"></div>
    </div>

    <script>
        let matrixClient;

        async function login() {
            const baseUrl = document.getElementById('hs-url').value;
            const user = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // 1. Create the client
            matrixClient = matrixcs.createClient(baseUrl);

            try {
                // 2. Authenticate
                const result = await matrixClient.login("m.login.password", { user, password });
                
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('client-area').style.display = 'block';
                document.getElementById('user-display').innerText = result.user_id;

                startSync();
            } catch (err) {
                alert("Login failed: " + err.message);
            }
        }

        async function startSync() {
            // 3. Start the client (initial sync)
            await matrixClient.startClient({ initialSyncLimit: 10 });

            matrixClient.once('sync', (state) => {
                if (state === "PREPARED") {
                    appendLog("Connected and Synced!");
                    listenForMessages();
                }
            });
        }

        function listenForMessages() {
            matrixClient.on("Room.timeline", (event, room, toStartOfTimeline) => {
                if (toStartOfTimeline) return; // Don't log old history
                if (event.getType() !== "m.room.message") return;

                const sender = event.getSender();
                const body = event.getContent().body;
                appendLog(`[${room.name}] ${sender}: ${body}`);
            });
        }

        function appendLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML += `<div>${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>

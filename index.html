<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --accent-color: 139, 92, 246; /* Default Purple */
            --accent-hex: #8b5cf6;
            --bg-image: none;
            --bg-opacity: 0.15;
            --bg-blur: 20px;
        }

        body {
            background-color: #0a0514;
            color: #f1f5f9;
            transition: background-color 0.3s ease;
        }

        #dynamic-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            opacity: var(--bg-opacity);
            filter: blur(var(--bg-blur));
            transition: all 0.5s ease;
        }

        #default-gradients {
            position: fixed;
            inset: 0;
            z-index: -2;
            background-image: 
                radial-gradient(at 0% 0%, rgba(var(--accent-color), 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(var(--accent-color), 0.1) 0px, transparent 50%);
        }

        .glass {
            background: rgba(15, 7, 25, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(var(--accent-color), 0.15);
        }

        .accent-bg { background-color: rgb(var(--accent-color)); }
        .accent-text { color: rgb(var(--accent-color)); }
        .accent-border { border-color: rgba(var(--accent-color), 0.5); }
        .accent-shadow { shadow: 0 10px 15px -3px rgba(var(--accent-color), 0.3); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(var(--accent-color), 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(var(--accent-color), 0.4); }
        
        .media-preview {
            max-width: 100%;
            max-height: 450px;
            border-radius: 16px;
            margin-top: 10px;
            object-fit: contain;
            display: block;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #000;
        }

        .shimmer {
            background: linear-gradient(90deg, rgba(var(--accent-color), 0.05) 25%, rgba(var(--accent-color), 0.1) 50%, rgba(var(--accent-color), 0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .collapsed-content { display: none; }
        
        .setting-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }
        .setting-card:hover {
            border-color: rgba(var(--accent-color), 0.3);
            background: rgba(var(--accent-color), 0.02);
        }
    </style>
</head>
<body class="h-screen overflow-hidden font-sans text-sm">

    <div id="dynamic-bg"></div>
    <div id="default-gradients"></div>

    <!-- Login Modal -->
    <div id="login-overlay" class="fixed inset-0 bg-[#050208]/95 flex items-center justify-center z-50 p-4">
        <div class="glass rounded-[2rem] shadow-2xl p-10 w-full max-w-md accent-border">
            <div class="flex flex-col items-center mb-8">
                <h1 class="text-4xl font-black text-white tracking-tighter italic uppercase">Matrix</h1>
                <p class="accent-text text-[10px] mt-2 font-bold uppercase tracking-[0.3em] opacity-80">Custom Web Client</p>
            </div>
            <div class="space-y-4">
                <input id="hs-url" type="text" value="https://matrix.org" class="w-full bg-black/40 p-4 border border-white/10 rounded-2xl focus:accent-border outline-none text-white transition-all text-sm shadow-inner" placeholder="Homeserver">
                <input id="user-id" type="text" placeholder="@user:matrix.org" class="w-full bg-black/40 p-4 border border-white/10 rounded-2xl focus:accent-border outline-none text-white transition-all text-sm shadow-inner">
                <input id="password" type="password" placeholder="Password" class="w-full bg-black/40 p-4 border border-white/10 rounded-2xl focus:accent-border outline-none text-white transition-all text-sm shadow-inner">
                <button id="login-btn" class="accent-bg w-full text-white py-4 rounded-2xl font-bold hover:opacity-90 transition-all active:scale-[0.98] mt-4 uppercase tracking-wider">Initialize</button>
                <p id="login-error" class="text-red-400 text-xs hidden text-center mt-2 p-3 bg-red-400/10 rounded-xl border border-red-400/20 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="main-ui" class="hidden flex h-screen p-4 gap-4">
        <!-- Sidebar -->
        <div class="w-80 glass rounded-[2rem] flex flex-col shrink-0 overflow-hidden border-white/10 shadow-2xl">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                <div class="flex items-center gap-3">
                    <div id="user-avatar" class="w-10 h-10 rounded-xl bg-gradient-to-tr from-slate-700 to-slate-900 flex items-center justify-center text-xs font-black shadow-lg">?</div>
                    <div class="flex flex-col">
                        <span id="user-display" class="font-bold text-white text-sm leading-tight">User</span>
                        <span id="sync-status-text" class="text-[9px] accent-text font-bold uppercase tracking-widest opacity-70">Awaiting Auth</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button id="settings-toggle-btn" class="p-2.5 hover:bg-white/10 rounded-xl transition-all text-white/50 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    <button id="logout-btn" class="p-2.5 hover:bg-red-500/20 rounded-xl transition-all text-red-400" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
            
            <div id="room-list" class="overflow-y-auto custom-scrollbar flex-1 p-3 space-y-4">
                <!-- Spaces and Rooms injected here -->
            </div>
        </div>

        <!-- Chat / View Area -->
        <div id="view-area" class="flex-1 glass rounded-[2rem] flex flex-col overflow-hidden border-white/10 shadow-2xl relative">
            
            <!-- Chat Container -->
            <div id="chat-view" class="flex flex-col h-full">
                <div id="chat-header" class="px-8 py-5 border-b border-white/10 bg-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div id="room-header-icon" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-xl font-bold border border-white/10">#</div>
                        <div>
                            <h2 id="current-room-name" class="font-black text-xl text-white tracking-tight leading-none">Matrix Node</h2>
                            <div class="flex items-center gap-2 mt-1.5">
                                <div id="sync-dot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                                <p id="sync-status" class="text-[9px] font-bold uppercase tracking-[0.1em] text-white/50">System Standby</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="message-container" class="flex-1 overflow-y-auto p-8 space-y-8 custom-scrollbar bg-black/20">
                    <div class="h-full flex flex-col items-center justify-center text-white/10">
                        <div class="w-20 h-20 border-2 border-dashed border-white/10 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                        </div>
                        <p class="font-bold text-[10px] tracking-[0.2em] uppercase opacity-40">Decrypting Message Buffers...</p>
                    </div>
                </div>

                <div class="p-6 bg-white/5 border-t border-white/10">
                    <form id="msg-form" class="flex gap-4 items-end max-w-6xl mx-auto">
                        <label class="group cursor-pointer bg-white/5 p-4 border border-white/10 rounded-2xl hover:bg-white/10 hover:accent-border transition-all flex items-center justify-center shrink-0">
                            <svg class="w-6 h-6 accent-text group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" /></svg>
                            <input type="file" id="file-input" class="hidden">
                        </label>
                        <div class="flex-1 relative">
                            <input id="msg-input" type="text" placeholder="Type a message..." class="w-full bg-black/40 p-4 border border-white/10 rounded-2xl focus:accent-border outline-none text-white transition-all text-sm shadow-inner placeholder:text-white/20" disabled>
                        </div>
                        <button type="submit" id="send-btn" class="accent-bg text-white px-8 h-[58px] rounded-2xl font-bold hover:opacity-90 disabled:opacity-20 shadow-xl transition-all active:scale-95 flex items-center justify-center shrink-0 uppercase text-xs tracking-widest" disabled>
                            <span>Send</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Settings Container (Hidden by default) -->
            <div id="settings-view" class="hidden flex flex-col h-full bg-[#050208]/40 overflow-y-auto custom-scrollbar">
                <div class="px-10 py-8 border-b border-white/10 bg-white/5 flex items-center justify-between sticky top-0 backdrop-blur-md z-10">
                    <h2 class="font-black text-2xl text-white tracking-tight">System Configuration</h2>
                    <button id="close-settings-btn" class="p-2 hover:bg-white/10 rounded-full transition-all">
                        <svg class="w-6 h-6 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="p-10 space-y-12 max-w-3xl">
                    <!-- Accent Color Section -->
                    <section>
                        <h3 class="text-xs font-black uppercase tracking-[0.3em] accent-text mb-6">UI Accent</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <button onclick="setAccent('#8b5cf6')" class="setting-card p-4 rounded-2xl flex flex-col items-center gap-3 group">
                                <div class="w-10 h-10 rounded-full bg-purple-500 shadow-[0_0_15px_rgba(139,92,246,0.5)]"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-white/60 group-hover:text-white transition-colors">Midnight</span>
                            </button>
                            <button onclick="setAccent('#ec4899')" class="setting-card p-4 rounded-2xl flex flex-col items-center gap-3 group">
                                <div class="w-10 h-10 rounded-full bg-pink-500 shadow-[0_0_15px_rgba(236,72,153,0.5)]"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-white/60 group-hover:text-white transition-colors">Neon Pink</span>
                            </button>
                            <button onclick="setAccent('#06b6d4')" class="setting-card p-4 rounded-2xl flex flex-col items-center gap-3 group">
                                <div class="w-10 h-10 rounded-full bg-cyan-500 shadow-[0_0_15px_rgba(6,182,212,0.5)]"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-white/60 group-hover:text-white transition-colors">Cyan</span>
                            </button>
                            <button onclick="setAccent('#10b981')" class="setting-card p-4 rounded-2xl flex flex-col items-center gap-3 group">
                                <div class="w-10 h-10 rounded-full bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.5)]"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-white/60 group-hover:text-white transition-colors">Matrix</span>
                            </button>
                        </div>
                        <div class="mt-6 flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5">
                            <span class="text-xs font-bold text-white/40 uppercase tracking-widest">Custom Hex</span>
                            <input type="color" id="custom-accent-input" class="w-10 h-10 bg-transparent border-none cursor-pointer rounded overflow-hidden">
                            <input type="text" id="custom-accent-hex" placeholder="#FFFFFF" class="bg-black/40 border border-white/10 rounded-xl px-4 py-2 text-xs font-mono text-white outline-none focus:accent-border w-24">
                        </div>
                    </section>

                    <!-- Background Section -->
                    <section>
                        <h3 class="text-xs font-black uppercase tracking-[0.3em] accent-text mb-6">Backdrop </h3>
                        <div class="space-y-6">
                            <div class="p-6 rounded-3xl bg-white/5 border border-white/5 space-y-4">
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-bold uppercase tracking-widest text-white/40">Backdrop URL</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="bg-url-input" placeholder="https://example.com/image.jpg" class="flex-1 bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-xs text-white outline-none focus:accent-border">
                                        <button id="clear-bg-btn" class="px-4 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all">Clear</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="flex flex-col gap-3">
                                        <label class="text-[10px] font-bold uppercase tracking-widest text-white/40 flex justify-between">
                                            <span>Blur Intensity</span>
                                            <span id="blur-val">20px</span>
                                        </label>
                                        <input type="range" id="bg-blur-slider" min="0" max="100" value="20" class="accent-bg">
                                    </div>
                                    <div class="flex flex-col gap-3">
                                        <label class="text-[10px] font-bold uppercase tracking-widest text-white/40 flex justify-between">
                                            <span>Opacity</span>
                                            <span id="opacity-val">15%</span>
                                        </label>
                                        <input type="range" id="bg-opacity-slider" min="0" max="100" value="15" class="accent-bg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <div class="pt-8 border-t border-white/5 text-center">
                        <p class="text-[10px] font-bold uppercase tracking-[0.4em] text-white/20">Preferences stored in local memory</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            hsUrl: '',
            accessToken: '',
            userId: '',
            currentRoomId: '',
            nextBatch: '',
            rooms: {},
            spaces: {},
            roomToSpace: {},
            collapsedSpaces: new Set(),
            isSyncing: false,
            blobCache: new Map(),
            settings: {
                accent: '#8b5cf6',
                bgUrl: '',
                bgBlur: 20,
                bgOpacity: 15
            }
        };

        const STORAGE_KEY = 'matrix_midnight_session';
        const SETTINGS_KEY = 'matrix_midnight_settings';

        const els = {
            loginOverlay: document.getElementById('login-overlay'),
            mainUi: document.getElementById('main-ui'),
            roomList: document.getElementById('room-list'),
            messageContainer: document.getElementById('message-container'),
            roomName: document.getElementById('current-room-name'),
            roomIcon: document.getElementById('room-header-icon'),
            msgInput: document.getElementById('msg-input'),
            sendBtn: document.getElementById('send-btn'),
            loginError: document.getElementById('login-error'),
            syncStatus: document.getElementById('sync-status'),
            syncStatusText: document.getElementById('sync-status-text'),
            syncDot: document.getElementById('sync-dot'),
            fileInput: document.getElementById('file-input'),
            userDisplay: document.getElementById('user-display'),
            userAvatar: document.getElementById('user-avatar'),
            logoutBtn: document.getElementById('logout-btn'),
            settingsView: document.getElementById('settings-view'),
            chatView: document.getElementById('chat-view'),
            settingsToggleBtn: document.getElementById('settings-toggle-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            bgUrlInput: document.getElementById('bg-url-input'),
            bgBlurSlider: document.getElementById('bg-blur-slider'),
            bgOpacitySlider: document.getElementById('bg-opacity-slider'),
            clearBgBtn: document.getElementById('clear-bg-btn'),
            customAccentHex: document.getElementById('custom-accent-hex'),
            customAccentInput: document.getElementById('custom-accent-input')
        };

        // HEX to RGB helper
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '139, 92, 246';
        }

        function applySettings() {
            const root = document.documentElement;
            root.style.setProperty('--accent-hex', state.settings.accent);
            root.style.setProperty('--accent-color', hexToRgb(state.settings.accent));
            root.style.setProperty('--bg-image', state.settings.bgUrl ? `url('${state.settings.bgUrl}')` : 'none');
            root.style.setProperty('--bg-blur', `${state.settings.bgBlur}px`);
            root.style.setProperty('--bg-opacity', state.settings.bgOpacity / 100);
            
            // Sync UI inputs
            els.bgUrlInput.value = state.settings.bgUrl;
            els.bgBlurSlider.value = state.settings.bgBlur;
            els.bgOpacitySlider.value = state.settings.bgOpacity;
            document.getElementById('blur-val').innerText = `${state.settings.bgBlur}px`;
            document.getElementById('opacity-val').innerText = `${state.settings.bgOpacity}%`;
            els.customAccentInput.value = state.settings.accent;
            els.customAccentHex.value = state.settings.accent.toUpperCase();

            localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
        }

        // Setting Actions
        window.setAccent = (color) => {
            state.settings.accent = color;
            applySettings();
        };

        els.bgUrlInput.oninput = (e) => {
            state.settings.bgUrl = e.target.value;
            applySettings();
        };

        els.bgBlurSlider.oninput = (e) => {
            state.settings.bgBlur = e.target.value;
            applySettings();
        };

        els.bgOpacitySlider.oninput = (e) => {
            state.settings.bgOpacity = e.target.value;
            applySettings();
        };

        els.clearBgBtn.onclick = () => {
            state.settings.bgUrl = '';
            applySettings();
        };

        els.customAccentInput.oninput = (e) => setAccent(e.target.value);
        els.customAccentHex.onchange = (e) => {
            let val = e.target.value;
            if (!val.startsWith('#')) val = '#' + val;
            if (/^#[0-9A-F]{6}$/i.test(val)) setAccent(val);
        };

        els.settingsToggleBtn.onclick = () => {
            els.chatView.classList.add('hidden');
            els.settingsView.classList.remove('hidden');
        };

        els.closeSettingsBtn.onclick = () => {
            els.settingsView.classList.add('hidden');
            els.chatView.classList.remove('hidden');
        };

        // Init Session & Settings
        window.addEventListener('load', () => {
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) {
                state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
            }
            applySettings();

            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    state.hsUrl = session.hsUrl;
                    state.accessToken = session.accessToken;
                    state.userId = session.userId;
                    if (state.accessToken && state.userId) {
                        showMainInterface();
                        startSync();
                    }
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
        });

        function showMainInterface() {
            els.loginOverlay.style.display = 'none';
            els.mainUi.classList.remove('hidden');
            const short = state.userId.split(':')[0].substring(1);
            els.userDisplay.innerText = short;
            els.userAvatar.innerText = short.charAt(0).toUpperCase();
        }

        async function loadMediaToCache(mxcUrl) {
            if (!mxcUrl || !mxcUrl.startsWith('mxc://')) return null;
            if (state.blobCache.has(mxcUrl)) return state.blobCache.get(mxcUrl);
            const mxcPart = mxcUrl.slice(6);
            const [serverName, mediaId] = mxcPart.split('/');
            const baseUrl = `${state.hsUrl}/_matrix/media/v3/download/${encodeURIComponent(serverName)}/${encodeURIComponent(mediaId)}`;
            try {
                const response = await fetch(baseUrl, { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    state.blobCache.set(mxcUrl, url);
                    return url;
                }
            } catch (e) { }
            return null;
        }

        async function apiRequest(method, path, body = null) {
            const url = `${state.hsUrl}/_matrix/client/v3${path}`;
            const headers = { 'Content-Type': 'application/json' };
            if (state.accessToken) headers['Authorization'] = `Bearer ${state.accessToken}`;
            const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
            if (!response.ok) throw await response.json();
            return response.json();
        }

        document.getElementById('login-btn').onclick = async () => {
            const hs = document.getElementById('hs-url').value.trim().replace(/\/+$/, "");
            els.loginError.classList.add('hidden');
            try {
                const res = await fetch(`${hs}/_matrix/client/v3/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'm.login.password',
                        user: document.getElementById('user-id').value,
                        password: document.getElementById('password').value
                    })
                }).then(r => r.json());
                
                if (res.access_token) {
                    state.hsUrl = hs;
                    state.accessToken = res.access_token;
                    state.userId = res.user_id;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({ hsUrl: state.hsUrl, accessToken: state.accessToken, userId: state.userId }));
                    showMainInterface();
                    startSync();
                } else throw res;
            } catch (err) {
                els.loginError.innerText = err.error || 'Access Denied';
                els.loginError.classList.remove('hidden');
            }
        };

        els.logoutBtn.onclick = () => {
            if (confirm("De-initialize session and wipe local buffers?")) {
                state.isSyncing = false;
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        async function startSync() {
            if (state.isSyncing) return;
            state.isSyncing = true;
            while (state.isSyncing) {
                try {
                    let url = `/sync?timeout=30000`;
                    if (state.nextBatch) url += `&since=${state.nextBatch}`;
                    const data = await apiRequest('GET', url);
                    state.nextBatch = data.next_batch;
                    handleSyncData(data);
                    els.syncStatus.innerText = 'Synchronized';
                    els.syncStatusText.innerText = 'Online';
                    els.syncDot.className = 'w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_12px_rgba(16,185,129,0.5)]';
                } catch (e) {
                    if (!state.isSyncing) break;
                    els.syncStatus.innerText = 'Reconnecting...';
                    els.syncDot.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
                    await new Promise(r => setTimeout(r, 5000));
                }
            }
        }

        function handleSyncData(data) {
            const joined = data.rooms?.join || {};
            let changed = false;
            for (const [roomId, roomData] of Object.entries(joined)) {
                if (!state.rooms[roomId]) {
                    state.rooms[roomId] = { messages: [], name: '', members: {}, type: 'room' };
                    changed = true;
                }
                const events = [...(roomData.state?.events || []), ...(roomData.timeline?.events || [])];
                events.forEach(ev => {
                    if (ev.type === 'm.room.create' && ev.content?.type === 'm.space') {
                        state.rooms[roomId].type = 'space';
                    }
                    if (ev.type === 'm.room.name' && ev.content?.name) {
                        state.rooms[roomId].name = ev.content.name;
                        changed = true;
                    } else if (ev.type === 'm.room.member') {
                        state.rooms[roomId].members[ev.state_key] = ev.content.displayname || ev.state_key;
                        changed = true;
                    } else if (ev.type === 'm.space.child') {
                        const childId = ev.state_key;
                        if (!state.spaces[roomId]) state.spaces[roomId] = new Set();
                        if (ev.content?.via) {
                            state.spaces[roomId].add(childId);
                            state.roomToSpace[childId] = roomId;
                            changed = true;
                        } else {
                            state.spaces[roomId].delete(childId);
                            delete state.roomToSpace[childId];
                        }
                    }
                    if (ev.type === 'm.room.message') {
                        if (!state.rooms[roomId].messages.some(m => m.event_id === ev.event_id)) {
                            state.rooms[roomId].messages.push(ev);
                            if (roomId === state.currentRoomId) appendMessage(ev);
                        }
                    }
                });
            }
            if (changed) renderRoomList();
        }

        function getRoomDisplayName(id) {
            const r = state.rooms[id];
            if (!r || !r.name) {
                if (r && r.members) {
                    const others = Object.keys(r.members).filter(m => m !== state.userId);
                    if (others.length === 1) return r.members[others[0]].split(':')[0].replace('@', '');
                }
                return id.substring(0, 10);
            }
            return r.name;
        }

        function toggleSpace(spaceId, e) {
            e.stopPropagation();
            if (state.collapsedSpaces.has(spaceId)) state.collapsedSpaces.delete(spaceId);
            else state.collapsedSpaces.add(spaceId);
            renderRoomList();
        }

        function renderRoomList() {
            const spaces = Object.keys(state.rooms).filter(id => state.rooms[id].type === 'space');
            const unparented = Object.keys(state.rooms).filter(id => state.rooms[id].type === 'room' && !state.roomToSpace[id]);

            let html = '';
            spaces.forEach(spaceId => {
                const isCollapsed = state.collapsedSpaces.has(spaceId);
                const children = Array.from(state.spaces[spaceId] || []);
                const name = getRoomDisplayName(spaceId);
                html += `
                    <div class="space-group">
                        <div onclick="toggleSpace('${spaceId}', event)" class="flex items-center gap-2 p-2 rounded-xl cursor-pointer hover:bg-white/5 group mb-1">
                            <svg class="w-3 h-3 accent-text transition-transform ${isCollapsed ? '-rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                            <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center font-black text-[10px] accent-text border border-white/5">S</div>
                            <span class="font-bold text-xs uppercase tracking-widest accent-text opacity-80 truncate">${name}</span>
                        </div>
                        <div class="relative ${isCollapsed ? 'collapsed-content' : ''}">
                            <div class="ml-6 space-y-1">
                                ${children.map(rid => renderRoomItem(rid)).join('')}
                            </div>
                        </div>
                    </div>`;
            });

            if (unparented.length > 0) {
                html += `<div class="pt-4 pb-2 px-2 text-[10px] font-black uppercase tracking-[0.2em] text-white/20 border-t border-white/5 mt-4">Direct Channels</div>`;
                html += unparented.map(rid => renderRoomItem(rid)).join('');
            }
            els.roomList.innerHTML = html || `<div class="p-8 text-center text-white/10 font-bold uppercase text-[10px]">Empty</div>`;
        }

        function renderRoomItem(id) {
            const isActive = id === state.currentRoomId;
            const name = getRoomDisplayName(id);
            return `
                <div onclick="selectRoom('${id}')" class="group p-3 cursor-pointer rounded-xl transition-all ${isActive ? 'accent-bg shadow-lg shadow-black/40' : 'hover:bg-white/5'}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg ${isActive ? 'bg-white/20' : 'bg-white/5'} flex items-center justify-center font-black text-xs text-white shrink-0 border border-white/5">
                            ${name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold truncate text-sm tracking-tight text-white">${name}</div>
                            <div class="text-[8px] font-bold uppercase tracking-widest ${isActive ? 'text-white/40' : 'accent-text opacity-40'} truncate"># ${id.substring(1, 10)}</div>
                        </div>
                    </div>
                </div>`;
        }

        function selectRoom(id) {
            state.currentRoomId = id;
            els.messageContainer.innerHTML = '';
            const name = getRoomDisplayName(id);
            els.roomName.innerText = name;
            els.roomIcon.innerText = name.charAt(0).toUpperCase();
            const sorted = (state.rooms[id].messages || []).sort((a, b) => a.origin_server_ts - b.origin_server_ts);
            sorted.forEach(appendMessage);
            els.msgInput.disabled = false;
            els.sendBtn.disabled = false;
            
            // Auto close settings if switching room
            els.settingsView.classList.add('hidden');
            els.chatView.classList.remove('hidden');
            renderRoomList();
        }

        async function appendMessage(ev) {
            const isMe = ev.sender === state.userId;
            const content = ev.content;
            const container = document.createElement('div');
            container.className = `flex group ${isMe ? 'justify-end' : 'justify-start'} w-full animate-in slide-in-from-bottom-2 duration-300`;
            const sender = ev.sender.split(':')[0].substring(1);
            const mxc = content.url || content.file?.url;

            container.innerHTML = `
                <div class="max-w-[80%] flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                    <span class="text-[9px] font-black uppercase tracking-widest accent-text mb-1 px-1 opacity-70">${sender}</span>
                    <div class="px-5 py-3.5 rounded-2xl ${isMe ? 'accent-bg text-white rounded-tr-none shadow-xl' : 'bg-white/5 border border-white/10 text-slate-200 rounded-tl-none'}">
                        <div class="msg-content text-[14px] leading-relaxed font-medium">${content.body || ''}</div>
                    </div>
                </div>`;
            
            els.messageContainer.appendChild(container);
            els.messageContainer.scrollTop = els.messageContainer.scrollHeight;

            if (mxc) {
                const div = container.querySelector('.msg-content');
                const load = document.createElement('div');
                load.className = 'w-64 h-40 rounded-xl shimmer mt-3';
                div.appendChild(load);
                const url = await loadMediaToCache(mxc);
                load.remove();
                if (url && content.msgtype === 'm.image') {
                    div.innerHTML = `<div class="mt-1"><img src="${url}" class="media-preview"></div>`;
                }
                els.messageContainer.scrollTop = els.messageContainer.scrollHeight;
            }
        }

        els.fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file || !state.currentRoomId) return;
            els.sendBtn.disabled = true;
            try {
                const url = `${state.hsUrl}/_matrix/media/v3/upload?filename=${encodeURIComponent(file.name)}`;
                const res = await fetch(url, { method: 'POST', headers: { 'Authorization': `Bearer ${state.accessToken}`, 'Content-Type': file.type }, body: file }).then(r => r.json());
                await apiRequest('PUT', `/rooms/${encodeURIComponent(state.currentRoomId)}/send/m.room.message/${Date.now()}`, { msgtype: 'm.file', body: file.name, url: res.content_uri });
            } catch (err) { } finally {
                els.sendBtn.disabled = false;
            }
        };

        document.getElementById('msg-form').onsubmit = async (e) => {
            e.preventDefault();
            const text = els.msgInput.value.trim();
            if (!text || !state.currentRoomId) return;
            els.msgInput.value = '';
            try { await apiRequest('PUT', `/rooms/${encodeURIComponent(state.currentRoomId)}/send/m.room.message/${Date.now()}`, { msgtype: 'm.text', body: text }); } catch (err) { }
        };
    </script>
</body>
</html>
